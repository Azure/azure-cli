# Generating Configuration Guidance

[Azdev](https://github.com/Azure/azure-cli-dev-tools) supports to generate a snapshot of command interfaces for a specified module since version 0.2.0.

## Output

### Folder structure
After generation, there will be a folder named `configuration` under the module dir.
And the subdirectories of `configuration` are named by profiles, such as `latest`, `2020-09-01-hybrid` and `2019-03-01-hybrid`.
Each profile named folders contain two json files named `commands.json` and `examples.json` respectively.

```
- <module dir>
    - ...
    - configuration
        - latest
            - commands.json
            - examples.json
        - 2020-09-01-hybrid
            - commands.json
            - examples.json
        - <other profile name>
            - commands.json
            - examples.json
```

### Simple Schema of `commands.json`

The schema of commands is a tree composed of `command group` nodes, `command` nodes and `argument` nodes.
Its root is a command group node names `az`. In our example, it's the father of sub command group names `network`,
and `network` is the father of command nodes (`list-service-aliases` and `list-service-tags`) and
command group nodes (`application-gateway`, `dns` and `lb`), and a command node, such as `create`, is the father of argument nodes.

```
{
  "az": {
    "full-name": "",
    "command-groups": {
      "network": {
        "full-name": "network",
        "help": "Manage Azure Network resources.",
        "commands": {
          "list-service-aliases": {
            "full-name": "network list-service-aliases",
            ...
          },
          "list-service-tags": {
            "full-name": "network list-service-tags",
            ...
          }
        },
        "command-groups": {
          "application-gateway": {
            "full-name": "network application-gateway",
            "help": {
              "short-summary": "Manage application-level routing and load balancing services.",
              "long-summary": "To learn more about Application Gateway, visit https://docs.microsoft.com/azure/application-gateway/application-gateway-create-gateway-cli"
            },
            "commands": {
              "create": {
                "full-name": "network application-gateway create",
                "help": "Create an application gateway.",
                "operation": "@.custom#create_application_gateway",
                "arguments": {
                  "application_gateway_name": {
                    ...
                  },
                  "connection_draining_timeout": {
                    "min-api": "2016-12-01",
                    "options": [
                      "--connection-draining-timeout"
                    ],
                    "help": "The time in seconds after a backend server is removed during which on open connection remains active. Range: 0 (disabled) to 3600",
                    "arg-group": "Gateway"
                  }
                }
              },
              "delete": {
                "full-name": "network application-gateway delete",
                ...
              }
            },
            "command-groups": {
              "address-pool": {
                "full-name": "network application-gateway address-pool",
                ...
              },
              "auth-cert": {
                "full-name": "network application-gateway auth-cert",
                ...
              }
            }
          },
          "dns": {
            "full-name": "network dns",
            ...
          },
          "lb": {
            "full-name": "network lb",
            ...
          }
        }
      }
    }
  }
}
```

### Simple Schema of `examples.json`

The schema is also a tree composed of `command group` nodes and `command` nodes. The examples will be in the corresponding command node.

```
{
  "az": {
    "command-groups": {
      "network": {
        "commands": {
          "list-service-aliases": [
            {
              "autogenerated": true,
              "name": "List available service aliases in the region which can be used for Service Endpoint Policies. (autogenerated)",
              "text": "az network list-service-aliases --location westus2"
            }
          ],
          "list-service-tags": [
            {
              "autogenerated": true,
              "name": "Gets a list of service tag information resources. (autogenerated)",
              "text": "az network list-service-tags --location westus2"
            }
          ],
          "list-usages": [
            ...
          ]
        },
        "command-groups": {
          "application-gateway": {
            "commands": {
              "create": [
                {
                  "name": "Create an application gateway with VMs as backend servers.",
                  "text": "az network application-gateway create -g MyResourceGroup -n MyAppGateway --capacity 2 --sku Standard_Medium --vnet-name MyVNet --subnet MySubnet --http-settings-cookie-based-affinity Enabled --public-ip-address MyAppGatewayPublicIp --servers 10.0.0.4 10.0.0.5"
                },
                {
                  "autogenerated": true,
                  "name": "Create an application gateway. (autogenerated)",
                  "text": "az network application-gateway create --capacity 2 --frontend-port MyFrontendPort --http-settings-cookie-based-affinity Enabled --http-settings-port 80 --http-settings-protocol Http --location westus2 --name MyAppGateway --public-ip-address MyAppGatewayPublicIp --resource-group MyResourceGroup --sku Standard_Small --subnet MySubnet --vnet-name MyVNet"
                }
              ],
              "delete": [
                ...
              ]
            },
            "command-groups": {
              "address-pool": {
                ...
              },
              "auth-cert": {
                ...
              }
            }
          },
          "dns": {
            ...
          },
          "lb": {
            ...
          }
        }
      }
    }
  }
}
```

## Code adaptions

In order to support configuration, some adjustments to existing code are required.

### Add decorators for special functions and classes

This decorators can be imported from package `azure.cli.core.translator`.

#### `client_factory` property

The `client_factory` property used in command definition.

If the value of `client_factory` is a function
```python
from azure.cli.command_modules.network._client_factory import cf_application_gateways

network_ag_sdk = CliCommandType(
    operations_tmpl='azure.mgmt.network.operations#ApplicationGatewaysOperations.{}',
    client_factory=cf_application_gateways
)

with self.command_group('network application-gateway waf-config') as g:
    g.custom_show_command('show', 'show_ag_waf_config')
    g.custom_command('list-rule-sets', 'list_ag_waf_rule_sets', client_factory=cf_application_gateways)
```
That function should be decorated by `client_factory_func`
```python
from azure.cli.core.translator import client_factory_func


@client_factory_func
def cf_application_gateways(cli_ctx, _):
    return network_client_factory(cli_ctx).application_gateways
```

#### `exception_handler` property
The `exception_handler` property used in command definition.

If the value of `exception_handler` is a function
```python
from azure.cli.core.commands.arm import handle_template_based_exception

with self.command_group('network lb', network_lb_sdk) as g:
    g.custom_command('create', 'create_load_balancer', exception_handler=handle_template_based_exception)
```
That function should be decorated by `exception_handler_func`
```python
from azure.cli.core.translator import exception_handler_func


@exception_handler_func
def handle_template_based_exception(ex):
    try:
        raise CLIError(ex.inner_exception.error.message)
    except AttributeError:
        raise CLIError(ex)
```

#### `transformer` and `table_transformer` properties
The `transformer` and `table_transformer` properties are used in command definition.

If the value is a function
```python
from azure.cli.command_modules.network._format import transform_network_usage_list, transform_network_usage_table

with self.command_group('network') as g:
    g.command('list-usages', 'list', transform=transform_network_usage_list, table_transformer=transform_network_usage_table)
```
Those function should be decorated by `transformer_func`
```python
from azure.cli.core.translator import transformer_func


@transformer_func
def transform_network_usage_list(result):
    result = list(result)
    for item in result:
        item.current_value = str(item.current_value)
        item.limit = str(item.limit)
        item.local_name = item.name.localized_value
    return result


@transformer_func
def transform_network_usage_table(result):
    transformed = []
    for item in result:
        transformed.append(OrderedDict([
            ('Name', item['localName']),
            ('CurrentValue', item['currentValue']),
            ('Limit', item['limit'])
        ]))
    return transformed
```

#### `validator` property

The `validator` property is used both in argument definition and command definition.

If the value of `validator` is a function
```python
from azure.cli.core.commands.validators import get_default_location_from_resource_group

with self.argument_context('network') as c:
    c.argument('location', arg_type=get_location_type(self.cli_ctx), validator=get_default_location_from_resource_group)
```
That function should be decorated by `validator_func`
```python
from azure.cli.core.translator import validator_func


@validator_func
def get_default_location_from_resource_group(cmd, namespace):
    if not namespace.location:
        from azure.cli.core.commands.client_factory import get_mgmt_service_client
        from msrestazure.azure_exceptions import CloudError
        from knack.util import CLIError

        resource_client = get_mgmt_service_client(cmd.cli_ctx, ResourceType.MGMT_RESOURCE_RESOURCES)
        try:
            rg = resource_client.resource_groups.get(namespace.resource_group_name)
        except CloudError as ex:
            raise CLIError('error retrieving default location: {}'.format(ex.message))
        namespace.location = rg.location  # pylint: disable=no-member
        logger.debug("using location '%s' from resource group '%s'", namespace.location, rg.name)

```

If the value of `validator` is a returned value of a function
```python
from azure.cli.command_modules.network._validators import get_public_ip_validator


with self.argument_context('network application-gateway frontend-ip create') as c:
    c.argument('public_ip_address', validator=get_public_ip_validator())

```
That function should be decorated by `validator_by_factory`
```python
from azure.cli.core.translator import validator_by_factory


@validator_by_factory
def get_public_ip_validator(has_type_field=False, allow_none=False, allow_new=False, default_none=False):
    def simple_validator(cmd, namespace):
        pass

    def complex_validator_with_type(cmd, namespace):
        pass

    return complex_validator_with_type if has_type_field else simple_validator
```

#### For `action` property

The `action` property is used in argument definition.

If the value of `action` is a class
```python
with self.argument_context('network application-gateway') as c:
    c.argument('trusted_client_cert', action=TrustedClientCertificateCreate)
```
This class should be decorated by `action_class`
```python
from azure.cli.core.translator import action_class


@action_class
class TrustedClientCertificateCreate(argparse._AppendAction):
    pass
```

If the value of `action` is a class returned by a function
```python
with self.argument_context('network application-gateway') as c:
    c.argument('trusted_client_cert', action=build_client_certification_action('special_value'))
```
This function should be decorated by `action_class_by_factory`
```python
from azure.cli.core.translator import action_class_by_factory


@action_class_by_factory
def build_client_certification_action(special_value):
    class TrustedClientCertificateCreate(argparse._AppendAction):
        pass
    return TrustedClientCertificateCreate
```

#### For `arg_type` property

The `arg_type` property is to define common used arguments.

If the value of `arg_type` is a instance defined in previous.
```python
name_arg_type = CLIArgumentType(options_list=['--name', '-n'], metavar='NAME')

with self.argument_context('network application-gateway ssl-policy predefined', min_api='2017-06-01') as c:
    c.argument('predefined_policy_name', name_arg_type)

with self.argument_context('network application-gateway ssl-policy', min_api='2017-06-01') as c:
    c.argument('policy_name', name_arg_type)
```
`CLIArgumentType` should be replaced by `register_arg_type`, and `register_arg_type` function needs a unique name in module to register this arg_type definition.
```python
from azure.cli.core.translator import register_arg_type
name_arg_type = register_arg_type('name_arg_type', options_list=['--name', '-n'], metavar='NAME')

with self.argument_context('network application-gateway ssl-policy predefined', min_api='2017-06-01') as c:
    c.argument('predefined_policy_name',  arg_type=name_arg_type)

with self.argument_context('network application-gateway ssl-policy', min_api='2017-06-01') as c:
    c.argument('policy_name',  arg_type=name_arg_type)
```

If the value of `arg_type` is a returned value of a function
```python
    with self.argument_context('network application-gateway rewrite-rule', arg_group='URL Configuration') as c:
        c.argument('enable_reroute', arg_type=get_three_state_flag())

```
That function should be decorated by `arg_type_by_factory`
```python
from azure.cli.core.translator import arg_type_by_factory


@arg_type_by_factory
def get_three_state_flag(positive_label='true', negative_label='false', invert=False, return_label=False):
    choices = [positive_label, negative_label]
    action = get_three_state_action(positive_label=positive_label, negative_label=negative_label, invert=invert,
                                    return_label=return_label)
    params = {
        'choices': CaseInsensitiveList(choices),
        'nargs': '?',
        'action': action
    }
    return CLIArgumentType(**params)
```


#### `type` property

The `type` property is used in argument definition to convert the value of input.

If the value of `type` is a function
```python
from azure.cli.core.commands.parameters import file_type

with self.argument_context('network application-gateway create', arg_group='Gateway') as c:
    c.argument('cert_data', options_list='--cert-file', type=file_type, completer=FilesCompleter())
```
That function should be decorated by `type_converter_func`
```python
from azure.cli.core.translator import type_converter_func


@type_converter_func
def file_type(path):
    import os
    return os.path.expanduser(path)
```

If the value of `type` is a returned value of a function
```python
from azure.cli.command_modules.monitor.actions import get_period_type


with self.argument_context('monitor alert update', arg_group='Condition') as c:
    c.argument('period', type=get_period_type())
```
That function should be decorated by `type_converter_by_factory`
```python
from azure.cli.core.translator import type_converter_by_factory


@type_converter_by_factory
def get_period_type(as_timedelta=False):

    def period_type(value):
        pass

    return period_type
```

Warning: Please use `json_object_type` defined in `azure.cli.core.commands` instead of `get_json_object` defined in `azure.cli.core.util`


#### `completer` property

The `completer` property is used in argument definition.

If the value of `completer` is a function
```python
from azure.cli.command_modules.network._completers import subnet_completion_list

with self.argument_context('network lb create', arg_group='Subnet') as c:
    c.argument('subnet', completer=subnet_completion_list)
```
That function should be decorated by `completer_func` instead of `Completer`
```python
from azure.cli.core.translator import completer_func


@completer_func
def subnet_completion_list(cmd, prefix, namespace, **kwargs):
    client = network_client_factory(cmd.cli_ctx)
    if namespace.resource_group_name and namespace.virtual_network_name:
        rg = namespace.resource_group_name
        vnet = namespace.virtual_network_name
        return [r.name for r in client.subnets.list(resource_group_name=rg, virtual_network_name=vnet)]

```

If the value of `completer` is a returned value of a function
```python
from azure.cli.command_modules.network._completers import get_lb_subresource_completion_list

with self.argument_context('network lb rule') as c:
    c.argument('item_name', options_list=['--name', '-n'], completer=get_lb_subresource_completion_list('load_balancing_rules'))
```
That function should be decorated by `completer_by_factory`
```python
from azure.cli.core.translator import completer_by_factory


@completer_by_factory
def get_lb_subresource_completion_list(prop):

    # @Completer # The 'Completer' decorator should be removed.
    def completer(cmd, prefix, namespace, **kwargs): 
        client = network_client_factory(cmd.cli_ctx)
        try:
            lb_name = namespace.load_balancer_name
        except AttributeError:
            lb_name = namespace.resource_name
        if namespace.resource_group_name and lb_name:
            lb = client.load_balancers.get(namespace.resource_group_name, lb_name)
            return [r.name for r in getattr(lb, prop)]
    return completer
```

If the value of `completer` is provided by external library
```python
from argcomplete.completers import FilesCompleter
from argcomplete.completers import DirectoriesCompleter


with self.argument_context('network vnet-gateway root-cert create') as c:
    c.argument('public_cert_data', type=file_type, completer=FilesCompleter())
    c.argument('cert_dir', type=file_type, completer=DirectoriesCompleter())

```
Those import should be registered in file `azure.cli.core.translator.external_completer` and import from that file.
`FilesCompleter` and `DirectoriesCompleter` are the most popular external completer, so they've already been registered.


### Use `register_custom_resource_type` instead of `CustomResourceType`

`CustomResourceType` is used in extension modules.
```python
from azure.cli.core.profiles import CustomResourceType
CUSTOM_MGMT_AKS_PREVIEW = CustomResourceType('azext_aks_preview.vendored_sdks.azure_mgmt_preview_aks', 'ContainerServiceClient')
```
It should be replaced by `register_custom_resource_type` with unique registered name provided.
```python
from azure.cli.core.translator import register_custom_resource_type
CUSTOM_MGMT_AKS_PREVIEW = register_custom_resource_type(
    'CUSTOM_MGMT_AKS_PREVIEW', 'azext_aks_preview.vendored_sdks.azure_mgmt_preview_aks', 'ContainerServiceClient')
```
