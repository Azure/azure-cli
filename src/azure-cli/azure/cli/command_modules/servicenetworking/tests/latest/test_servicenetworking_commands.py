# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

import os
import unittest
import tempfile

from azure.cli.testsdk import *
from knack.util import CLIError
from azure.cli.core.profiles import supported_api_version, ResourceType
from azure.cli.core.commands.client_factory import get_subscription_id
from azure.cli.testsdk import (
    ScenarioTest, LiveScenarioTest, LocalContextScenarioTest, ResourceGroupPreparer, live_only,
    KeyVaultPreparer, record_only)

TEST_DIR = os.path.abspath(os.path.join(os.path.abspath(__file__), '..'))

class TrafficControllerWithFrontendAndAssiociationScenario(ScenarioTest):
    #@ResourceGroupPreparer(parameter_name='cli_tc_testrg', location="northeurope")
    def test_servicenetworking_tc(self):

        self.kwargs.update({
            'rg': 'cl_tc_testrg',
            'tc': 'tc1',
            'fe': 'fe1',
            'ip': 'pip1',
            'aso': 'a1',
            'vnet': 'vnet1',
            'subnet': "s1"
        })

        # Create Resource group 
        self.cmd('group create -n {rg} --location northeurope')

        # Create Traffic Controller
        tcCount1 = len(self.cmd('service-networking traffic-controller list').get_output_in_json())
        self.cmd('service-networking traffic-controller create -g {rg} -n {tc} --tags foo=doo',
                    checks=self.check('tags.foo', 'doo'))
        tcCount2 = len(self.cmd('service-networking traffic-controller list').get_output_in_json())
        self.assertTrue(tcCount2 == tcCount1 + 1)
        self.cmd('service-networking traffic-controller show -g {rg} -n {tc}', checks=[
            self.check('name', '{tc}'),
            self.check('resourceGroup', '{rg}'),
            self.check('tags.foo', 'doo')
        ])

        # Create Frontend for traffic controller
        self.cmd('network public-ip create -g {rg} -n {ip} --sku Standard --tier Global --location eastus2')

        tcFrontendCount1 = len(self.cmd('service-networking traffic-controller frontend list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.cmd('service-networking traffic-controller frontend create -g {rg} -n {fe} --traffic-controller-name {tc} --public-ip-address {ip}')
        tcFrontendCount2 = len(self.cmd('service-networking traffic-controller frontend list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.assertTrue(tcFrontendCount2 == tcFrontendCount1 + 1)
        self.cmd('service-networking traffic-controller frontend show -g {rg} -n {fe} --traffic-controller-name {tc}', checks=[
            self.check('name', '{fe}')
        ])

        #Create Association for traffic controller
        vnet = self.cmd('network vnet create -g {rg} -n {vnet} --subnet-name {subnet}').get_output_in_json()
        subnet = self.cmd('network vnet subnet update -g {rg} -n {subnet} --vnet-name {vnet} --delegations Microsoft.ServiceNetworking/trafficControllers').get_output_in_json()

        associationCount1 = len(self.cmd('service-networking traffic-controller association list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.cmd('service-networking traffic-controller association create -g {rg} -n {aso} --traffic-controller-name {tc} --vnet-name {vnet} --subnet {subnet}')
        associationCount2 = len(self.cmd('service-networking traffic-controller association list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.assertTrue(associationCount2 == associationCount1 + 1)
        self.cmd('service-networking traffic-controller association show -g {rg} -n {aso} --traffic-controller-name {tc}', checks=[
            self.check('name', '{aso}')
        ])

        #Start Deleting
        self.cmd('service-networking traffic-controller association delete -g {rg} -n {aso} --traffic-controller-name {tc} -y')
        associationCount3 = len(self.cmd('service-networking traffic-controller association list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.assertTrue(associationCount3 == associationCount1)

        self.cmd('service-networking traffic-controller frontend delete -g {rg} -n {fe} --traffic-controller-name {tc} -y')
        tcFrontendCount3 = len(self.cmd('service-networking traffic-controller frontend list -g {rg} --traffic-controller-name {tc}').get_output_in_json())
        self.assertTrue(tcFrontendCount3 == tcFrontendCount1)

        self.cmd('service-networking traffic-controller delete -g {rg} -n {tc} -y')
        tcCount3 = len(self.cmd('service-networking traffic-controller list').get_output_in_json())
        self.assertTrue(tcCount3 == tcCount1)

        self.cmd('network public-ip delete -g {rg} -n {ip}')
        self.cmd('network vnet create -g {rg} -n {vnet}')
        self.cmd('group delete -n {rg} -y')