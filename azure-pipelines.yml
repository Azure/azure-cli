resources:
- repo: self

trigger:
  batch: true
  branches:
    include:
    - '*'
    exclude:
    - 'release*'

pr:
  branches:
    include:
    - '*'

variables:
- template: ${{ variables.Pipeline.Workspace }}/.azure-pipelines/templates/variables.yml
- name: Codeql.Enabled
  value: false
- name: ComponentDetection.ForceScan
  value: eq(variables['Build.SourceBranch'], 'refs/heads/release')

parameters:
- name: architectures
  type: object
  default:
  - name: AMD64
    value: amd64
    pool: pool-ubuntu-latest-multi-core
  - name: ARM64
    value: arm64
    pool: pool-ubuntu-latest-arm64

jobs:
- job: CodegenCoverage
  timeoutInMinutes: 600
  displayName: "Codegen Coverage"
  continueOnError: true
  pool:
    name: ${{ variables.ubuntu_pool }}
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: 3.11
  - template: .azure-pipelines/templates/azdev_setup.yml
  - bash: |
      set -ev
      . env/bin/activate
      # clone azure-cli-extensions
      cd ..
      git clone --depth 1 -b main https://github.com/Azure/azure-cli-extensions.git ./azure-cli-extensions
      azdev extension repo add ./azure-cli-extensions
      pip install setuptools==70.0.0 wheel==0.30.0
      azdev extension add "*"
      pip install msrestazure markupsafe==2.0.1
      # Some extension will change the dependence, so run `azdev setup` again after all extensions installed.
      azdev setup -c ./s -r ./azure-cli-extensions
      
      mkdir -p /tmp/module_stats
      
      find /mnt/vss/_work/1/s/src/azure-cli/azure/cli/command_modules/ -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | grep -v '^__pycache__$' > /mnt/vss/_work/1/s/scripts/ci/core_modules.txt
      echo "=== Core Modules ==="
      cat /mnt/vss/_work/1/s/scripts/ci/core_modules.txt
      
      find /mnt/vss/_work/1/azure-cli-extensions/src/ -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | grep -v '^__pycache__$' > /mnt/vss/_work/1/s/scripts/ci/extension_modules.txt
      echo "=== Extension Modules ==="
      cat /mnt/vss/_work/1/s/scripts/ci/extension_modules.txt
      
      for module in $(cat /mnt/vss/_work/1/s/scripts/ci/core_modules.txt); do
        azdev statistics list-command-table $module --statistics-only > /tmp/module_stats/${module}.json || true
      done
      
      for module in $(cat /mnt/vss/_work/1/s/scripts/ci/extension_modules.txt); do
        azdev statistics list-command-table $module --statistics-only > /tmp/module_stats/${module}.json || true
      done
      azdev statistics list-command-table --statistics-only > /tmp/codegen_report.json || true
      python /mnt/vss/_work/1/s/scripts/ci/codegen_report.py
    env:
      BUILD_ID: $(Build.BuildId)
      BUILD_BRANCH: $(Build.SourceBranchName)
    enabled: true
